<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Signing you in…</title>
</head>
<body>
  <p>Completing sign-in…</p>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7"></script>
  <script>
    (async () => {
      // Fetch config from backend
      const res = await fetch('/api/config');
      const { supabaseUrl, supabaseAnonKey } = await res.json();

      // IMPORTANT: create ONE client only
      const supabase = window.supabase.createClient(
        supabaseUrl,
        supabaseAnonKey,
        {
          auth: {
            persistSession: true,
            detectSessionInUrl: true
          }
        }
      );

      // This line FINALIZES OAuth and restores state
      const { data, error } = await supabase.auth.getSession();

      if (error || !data.session) {
        document.body.innerText = 'Login failed. Please try again.';
        return;
      }

      // OPTIONAL: call backend to init accounts (Google users)
      await fetch('/api/auth/google/complete', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${data.session.access_token}`
        }
      });

      // Redirect to app dashboard
      window.location.replace('/');
    })();
  </script>
</body>
</html>
