<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Signing you in…</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Inter, system-ui, -apple-system; padding:20px; background:#ffffff; color:#111; }
  </style>
</head>
<body>
  <h3>Completing sign-in…</h3>
  <div id="msg">Please wait</div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7"></script>
  <script>
    (async () => {
      const msg = id => { document.getElementById('msg').innerText = id; };
      try {
        // 1) fetch public config from your server
        const cfgRes = await fetch('/api/config');
        if (!cfgRes.ok) throw new Error('Failed to load config from server');
        const { supabaseUrl, supabaseAnonKey } = await cfgRes.json();

        // 2) create single client
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey, {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            // allow Supabase to parse callback URL and restore session (v2 recommended)
            detectSessionInUrl: true
          }
        });

        // 3) First try: let supabase parse the URL and restore session
        msg('Finalizing OAuth (automatic) ...');
        const { data: sessionData, error: sessionError } = await supabase.auth.getSession();

        if (sessionError) console.warn('getSession() returned error', sessionError);

        if (sessionData && sessionData.session) {
          // success path
          console.log('Session restored automatically', sessionData);
          msg('Signed in. Redirecting...');
          // call backend to initialize user (safe idempotent)
          await fetch('/api/auth/google/complete', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${sessionData.session.access_token}` }
          }).catch(e => console.warn('init accounts error', e));
          window.location.replace('/');
          return;
        }

        // 4) Fallback: if no session found, try explicit code exchange (if code exists)
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');

        if (!code) {
          // no code & no session => show helpful diagnostics
          console.error('No session and no code in URL. Full URL:', window.location.href);
          msg('Login failed: no session and no OAuth code found. Clear browser storage and try again.');
          return;
        }

        // 5) Exchange the code (explicit mode)
        msg('Exchanging OAuth code...');
        const { data, error } = await supabase.auth.exchangeCodeForSession(code);

        if (error || !data?.session) {
          console.error('exchangeCodeForSession failed', error);
          msg('Login failed during code exchange. See console for details.');
          return;
        }

        console.log('Code exchange success', data);
        msg('Signed in. Initializing account...');
        // call backend to initialize user (safe idempotent)
        await fetch('/api/auth/google/complete', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${data.session.access_token}` }
        }).catch(e => console.warn('init accounts error', e));

        // done
        window.location.replace('/');
      } catch (err) {
        console.error('Callback error:', err);
        document.getElementById('msg').innerText = 'Unexpected error during login. Check console.';
      }
    })();
  </script>
</body>
</html>
